name: Build & Test ROS 2 Humble ‚Äì grizzly

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  build_and_test:
    runs-on: ubuntu-22.04
    container:
      image: ros:humble
    defaults:
      run:
        shell: bash
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up ROS 2 Humble build tools
        uses: ros-tooling/setup-ros@v0.7
        with:
          required-ros-distributions: humble

      # Optional dependency install:
      # - name: Install dependencies via rosdep
      #   run: |
      #     sudo apt update
      #     rosdep update
      #     rosdep install --from-paths src --ignore-src -r -y

      - name: Build workspace
        run: |
          set -eo pipefail
          set +u
          source /opt/ros/humble/setup.bash
          set -u

          echo "üöß Building workspace..."
          colcon build --symlink-install

      - name: Source install space
        run: |
          set -eo pipefail
          set +u
          source install/setup.bash
          set -u

      - name: Allow GitHub Actions workspace as safe directory
        run: |
           git config --global --add safe.directory /__w/grizzly-25-26/grizzly-25-26

      - name: Run grizzly.py tests and verify passing tests
        run: |
          set -euo pipefail

          # Source workspace (avoid -u while sourcing)
          set +u
          source install/setup.bash
          source install/local_setup.bash
          set -u

          # Find grizzly.py in repository
          GRIZZLY_PATH=$(git ls-files | grep -m1 'grizzly.py' || true)
          if [ -z "$GRIZZLY_PATH" ]; then
            echo "‚ùå grizzly.py not found in repository files."
            exit 1
          fi
          echo "Found grizzly.py at: $GRIZZLY_PATH"

          # Try common test invocations (use timeout to bound run time)
          : > grizzly_test.out

          try_and_capture() {
            CMD="$1"
            echo "üîÅ Trying: $CMD"
            if timeout 120s bash -lc "$CMD" > grizzly_test.out 2>&1; then
              echo "‚úÖ Command succeeded: $CMD"
              return 0
            else
              echo "‚ö† Command failed or exited non-zero: $CMD"
              return 1
            fi
          }

          if try_and_capture "python3 \"$GRIZZLY_PATH\" --test"; then
            :
          elif try_and_capture "python3 \"$GRIZZLY_PATH\" test"; then
            :
          elif try_and_capture "python3 \"$GRIZZLY_PATH\" --run-tests"; then
            :
          elif [ -x "$GRIZZLY_PATH" ] && try_and_capture "\"$GRIZZLY_PATH\" --test"; then
            :
          elif [ -x "$GRIZZLY_PATH" ] && try_and_capture "\"$GRIZZLY_PATH\" test"; then
            :
          else
            echo "‚ùå Failed to run any recognized test command for grizzly.py. Last output:"
            tail -n 200 grizzly_test.out || true
            exit 1
          fi

          echo "---- grizzly.py test output (tail 200 lines) ----"
          tail -n 200 grizzly_test.out || true

          # Look for common passing-test markers (case-insensitive)
          if grep -Eiq "(all tests passed|passed:[[:space:]]*[0-9]+|[0-9]+ passed|^OK\\b|0 failed|tests:.*passed)" grizzly_test.out; then
            echo "‚úÖ Tests appear to have passed according to output."
            exit 0
          else
            echo "‚ùå Could not detect passing tests in grizzly.py output."
            exit 1
          fi

  release:
    needs: build_and_test
    if: ${{ github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master') }}
    permissions:
      contents: write
    uses: ./.github/workflows/release.yml
    with:
      build_sha: ${{ github.sha }}
    secrets: inherit
