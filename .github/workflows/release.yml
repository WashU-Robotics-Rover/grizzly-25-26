name: Release – grizzly

on:
  workflow_call:
    inputs:
      build_sha:
        description: "Commit SHA to release"
        required: false
        type: string

# Can be explicit or `inherit`; explicit keeps intent clear
permissions:
  contents: write

jobs:
  release_sources:
    runs-on: ubuntu-22.04
    container:
      image: ros:humble
    defaults:
      run:
        shell: bash
    steps:
      - name: Checkout source (match the built commit)
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.build_sha || github.sha }}

      - name: Install helper tools
        run: |
          set -euo pipefail
          apt-get update
          apt-get install -y --no-install-recommends jq rsync
          rm -rf /var/lib/apt/lists/*

      - name: Write installer script
        run: |
          set -euo pipefail
          cat > install_grizzly.sh <<'EOF'
          #!/usr/bin/env bash
          set -euo pipefail
          WANT_ROSDEP=1
          BUILD_TYPE="RelWithDebInfo"
          for arg in "$@"; do
            case "$arg" in
              --no-rosdep) WANT_ROSDEP=0 ;;
              --release)   BUILD_TYPE="Release" ;;
              *) echo "Unknown arg: $arg" >&2; exit 2 ;;
            esac
          done
          if ! command -v colcon >/dev/null 2>&1; then
            echo "colcon not found. Make sure ROS 2 Humble is installed and sourced." >&2
            echo "For Docker: use 'ros:humble' or source /opt/ros/humble/setup.bash" >&2
            exit 1
          fi
          if [ -f /opt/ros/humble/setup.bash ]; then
            set +u
            source /opt/ros/humble/setup.bash
            set -u
          fi
          if [ "$WANT_ROSDEP" -eq 1 ] && command -v rosdep >/dev/null 2>&1; then
            set +e
            rosdep update
            set -e
            rosdep install --from-paths . --ignore-src -r -y || {
              echo "rosdep install completed with non-fatal errors; continuing." >&2
            }
          fi
          echo "Building with CMAKE_BUILD_TYPE=${BUILD_TYPE} ..."
          colcon build --symlink-install --cmake-args -DCMAKE_BUILD_TYPE="${BUILD_TYPE}"
          cat <<EONOTE
          =======================
          ✅ Build finished.
          To use this workspace in the current shell:
              source install/setup.bash
          You can add this line to your shell RC:
              echo 'source "$(pwd)/install/setup.bash"' >> ~/.bashrc   # or ~/.zshrc
          =======================
          EONOTE
          EOF
          chmod +x install_grizzly.sh

      - name: Write quick README
        run: |
          set -euo pipefail
          cat > README_INSTALL.md <<'EOF'
          # grizzly – source release
          This archive contains the **source** for the `grizzly` ROS 2 (Humble) package(s),
          plus a helper installer script.
          ## Requirements
          - ROS 2 Humble environment (e.g., `/opt/ros/humble`), including `colcon`
          - `rosdep` (recommended)
          ## Build & Use
          ```bash
          ./install_grizzly.sh
          source install/setup.bash
          ```
          Optional flags:
          - `--no-rosdep`  : skip dependency installation
          - `--release`    : use `-DCMAKE_BUILD_TYPE=Release`
          EOF

      - name: Stage package sources
        run: |
          set -euo pipefail
          mkdir -p out/src
          rsync -a \
            --exclude '.git*' \
            --exclude '.github' \
            --exclude 'build' \
            --exclude 'install' \
            --exclude 'log' \
            ./ out/src/
          cp install_grizzly.sh README_INSTALL.md out/

      - name: Prepare source archive
        id: prep
        run: |
          set -euo pipefail
          SHORT_SHA="${GITHUB_SHA::7}"
          BUILD_DATE="$(date -u +%Y%m%d%H%M%S)"
          VERSION="${BUILD_DATE}-${SHORT_SHA}"
          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"
          TAR="grizzly-source-${VERSION}.tar.gz"
          (cd out && tar -czf "../${TAR}" .)
          sha256sum "${TAR}" > "SHA256SUMS"
          jq -n --arg version "$VERSION" --arg sha "$GITHUB_SHA" --arg date "$BUILD_DATE" \
            '{artifact:"source", version:$version, commit:$sha, built_at_utc:$date, distro:"humble"}' > "version.json"
          echo "tar=${TAR}" >> "$GITHUB_OUTPUT"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: "auto-${{ steps.prep.outputs.version }}"
          name: "grizzly source ${{ steps.prep.outputs.version }}"
          draft: false
          prerelease: true
          files: |
            ${{ steps.prep.outputs.tar }}
            SHA256SUMS
            version.json
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
