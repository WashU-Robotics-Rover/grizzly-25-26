name: Release â€“ grizzly

on:
  workflow_call:
    inputs:
      build_sha:
        description: "Commit SHA to release"
        required: false
        type: string

# Can be explicit or `inherit`; explicit keeps intent clear
permissions:
  contents: write

jobs:
  release_sources:
    runs-on: ubuntu-22.04
    container:
      image: ros:humble
    defaults:
      run:
        shell: bash
    steps:
      - name: Checkout source (match the built commit)
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.build_sha || github.sha }}

      - name: Install helper tools
        run: |
          set -euo pipefail
          apt-get update
          apt-get install -y --no-install-recommends jq rsync
          rm -rf /var/lib/apt/lists/*

      - name: Stage package sources
        run: |
          set -euo pipefail
          mkdir -p out/src
          rsync -a \
            --exclude '.git*' \
            --exclude '.github' \
            --exclude 'build' \
            --exclude 'install' \
            --exclude 'log' \
            ./ out/src/
          cp install_grizzly.sh README_INSTALL.md out/

      - name: Prepare source archive
        id: prep
        run: |
          set -euo pipefail
          SHORT_SHA="${GITHUB_SHA::7}"
          BUILD_DATE="$(date -u +%Y%m%d%H%M%S)"
          VERSION="${BUILD_DATE}-${SHORT_SHA}"
          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"
          TAR="grizzly-source-${VERSION}.tar.gz"
          (cd out && tar -czf "../${TAR}" .)
          sha256sum "${TAR}" > "SHA256SUMS"
          jq -n --arg version "$VERSION" --arg sha "$GITHUB_SHA" --arg date "$BUILD_DATE" \
            '{artifact:"source", version:$version, commit:$sha, built_at_utc:$date, distro:"humble"}' > "version.json"
          echo "tar=${TAR}" >> "$GITHUB_OUTPUT"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: "auto-${{ steps.prep.outputs.version }}"
          name: "grizzly source ${{ steps.prep.outputs.version }}"
          draft: false
          prerelease: true
          files: |
            ${{ steps.prep.outputs.tar }}
            SHA256SUMS
            version.json
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
